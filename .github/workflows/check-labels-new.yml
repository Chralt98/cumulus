name: Check labels (new)

on:
  pull_request:
    types: [labeled, opened, synchronize, unlabeled]

jobs:
  check-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Check labels
        continue-on-error: true
        env:
          IMAGE: chevdor/ruled-labels:latest
          MOUNT: /work
          CHECK_SPECS: specs.yaml
          GITHUB_PR: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_BASE: https://api.github.com/repos
          REPO: ${{ github.repository }}
        run: |
          echo "REPO: $REPO"
          echo "GITHUB_PR: $GITHUB_PR"

          # Fetch the labels for the PR under test
          labels=($( curl -H "Authorization: token $GITHUB_TOKEN" -s "$API_BASE/$REPO/pulls/$GITHUB_PR" | jq '.labels | .[] | .name' | tr '\n' ' '))

          docker pull $IMAGE
          docker run --rm -i $IMAGE --version
          echo $labels | xargs -I{} docker run --rm -i -v $PWD/scripts/ci/ruled_labels/:$MOUNT $IMAGE check $MOUNT/$CHECK_SPECS --labels {}
